# DXSpider Full Stack - Unified Docker Compose Configuration
#
# This file combines all DXSpider services with optional features via profiles
#
# Usage:
#   All features:     docker compose -f docker-compose.full.yml --profile all up -d
#   Only metrics:     docker compose -f docker-compose.full.yml --profile metrics up -d
#   Only dashboard:   docker compose -f docker-compose.full.yml --profile dashboard up -d
#   With database:    docker compose -f docker-compose.full.yml --profile database up -d
#   Custom combo:     docker compose -f docker-compose.full.yml --profile dashboard --profile metrics up -d
#
# IMPORTANT: Copy .env.example to .env and configure before deployment
#   cp .env.example .env
#   nano .env

services:
  # ===========================================================================
  # DXSpider Cluster Node (Core Service - Always Deployed)
  # ===========================================================================
  dxspider:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - "linux/arm64"
        - "linux/amd64"
      args:
        - SPIDER_VERSION=${CLUSTER_DXSPIDER_BRANCH:-mojo}
        - SPIDER_USERNAME=${CLUSTER_DB_USER:-sysop}

    environment:
      - SPIDER_INSTALL_DIR=/spider
      - CLUSTER_CALLSIGN=${CLUSTER_CALLSIGN}
      - CLUSTER_LOCATOR=${CLUSTER_LOCATOR}
      - CLUSTER_QTH=${CLUSTER_QTH}
      - CLUSTER_SYSOP_NAME=${CLUSTER_SYSOP_NAME}
      - CLUSTER_SYSOP_CALLSIGN=${CLUSTER_SYSOP_CALLSIGN}
      - CLUSTER_SYSOP_EMAIL=${CLUSTER_SYSOP_EMAIL}
      - CLUSTER_SYSOP_BBS_ADDRESS=${CLUSTER_SYSOP_BBS_ADDRESS}
      - CLUSTER_LATITUDE=${CLUSTER_LATITUDE}
      - CLUSTER_LONGITUDE=${CLUSTER_LONGITUDE}
      - SPIDER_USERNAME=${CLUSTER_DB_USER:-sysop}
      - CLUSTER_DSN=dbi:mysql:${CLUSTER_DB_NAME:-dxspider}:${CLUSTER_DB_HOSTNAME:-mariadb}:${CLUSTER_DB_PORT:-3306}
      - CLUSTER_DBUSER=${CLUSTER_DB_USER:-sysop}
      - CLUSTER_DBPASS=${CLUSTER_DB_PASS}
      - CLUSTER_PORT=${CLUSTER_PORT:-7300}
      - CLUSTER_SYSOP_PORT=${CLUSTER_SYSOP_PORT:-8050}
      - CLUSTER_METRICS_PORT=${CLUSTER_METRICS_PORT:-9100}

    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost ${CLUSTER_PORT:-7300} && pgrep -f cluster.pl > /dev/null"]
      interval: 30s
      start_period: 10s
      retries: 3
      timeout: 10s

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    volumes:
      - ./startup:/spider/scripts/startup:rw
      - ./crontab:/spider/local_cmd/crontab:rw
      - ./connect:/spider/connect:rw
      - ./motd:/spider/local_data/motd:rw
      - ./local_data:/spider/local_data:rw
      - ./cmd:/spider/cmd:rw
      - ./msg:/spider/msg:rw
      - ./metrics/prometheus/metrics_server.pl:/spider/metrics/metrics_server.pl:ro

    ports:
      - "${CLUSTER_PORT:-7300}:${CLUSTER_PORT:-7300}"
      - "${CLUSTER_SYSOP_PORT:-8050}:${CLUSTER_SYSOP_PORT:-8050}"
      - "${CLUSTER_METRICS_PORT:-9100}:${CLUSTER_METRICS_PORT:-9100}"

    networks:
      - dxspider-net
      - metrics-net

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    stop_grace_period: 30s

  # ===========================================================================
  # MariaDB Database (Optional - Profile: database)
  # ===========================================================================
  mariadb:
    image: mariadb:10.11
    profiles:
      - database
      - all

    environment:
      - MYSQL_ROOT_PASSWORD=${CLUSTER_DB_ROOT_PWD:-rootpassword}
      - MYSQL_DATABASE=${CLUSTER_DB_NAME:-dxspider}
      - MYSQL_USER=${CLUSTER_DB_USER:-sysop}
      - MYSQL_PASSWORD=${CLUSTER_DB_PASS}

    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      start_period: 30s
      retries: 5
      timeout: 5s

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    volumes:
      - mariadb_data:/var/lib/mysql

    networks:
      - dxspider-net

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # DXSpider Dashboard (Optional - Profile: dashboard)
  # ===========================================================================
  dashboard:
    image: alpine:3.20
    container_name: dxspider-dashboard
    profiles:
      - dashboard
      - all

    environment:
      - SPIDER_INSTALL_DIR=/spider
      - DASHBOARD_PORT=${DASHBOARD_PORT:-8080}
      - DASHBOARD_MAX_SPOTS=${DASHBOARD_MAX_SPOTS:-100}
      - DASHBOARD_CORS_ORIGIN=${DASHBOARD_CORS_ORIGIN:-}
      - CLUSTER_CALLSIGN=${CLUSTER_CALLSIGN:-UNKNOWN}
      - CLUSTER_QTH=${CLUSTER_QTH:-Unknown Location}
      - CLUSTER_LOCATOR=${CLUSTER_LOCATOR:-}

    command: >
      sh -c "
        apk add --no-cache perl perl-mojolicious perl-io-socket-ssl &&
        cd /dashboard/server &&
        perl dashboard.pl
      "

    volumes:
      - ./dashboard/server:/dashboard/server:ro
      - ./dashboard/templates:/dashboard/server/templates:ro
      - ./dashboard/public:/dashboard/server/public:ro
      - ./local_data:/spider/local_data:ro
      - ./cmd:/spider/cmd:ro

    ports:
      - "${DASHBOARD_PORT:-8080}:${DASHBOARD_PORT:-8080}"

    networks:
      - dxspider-net

    depends_on:
      dxspider:
        condition: service_healthy

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:${DASHBOARD_PORT:-8080}/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # Prometheus (Optional - Profile: metrics)
  # ===========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: dxspider-prometheus
    profiles:
      - metrics
      - all

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--storage.tsdb.retention.size=10GB'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'

    ports:
      - "9090:9090"

    volumes:
      - ./metrics/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus

    networks:
      - metrics-net

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # Grafana (Optional - Profile: metrics)
  # ===========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: dxspider-grafana
    profiles:
      - metrics
      - all

    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:?ERROR: GF_ADMIN_PASSWORD must be set in .env}
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_SERVER_DOMAIN=localhost
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_INSTALL_PLUGINS=grafana-piechart-panel

    ports:
      - "3000:3000"

    volumes:
      - grafana_data:/var/lib/grafana
      - ./metrics/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./metrics/grafana/provisioning/dashboards/dxspider.yml:/etc/grafana/provisioning/dashboards/dxspider.yml:ro
      - ./metrics/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro

    networks:
      - metrics-net

    depends_on:
      - prometheus

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ===========================================================================
# Networks
# ===========================================================================
networks:
  dxspider-net:
    driver: bridge

  metrics-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  mariadb_data:
    driver: local

  prometheus_data:
    driver: local

  grafana_data:
    driver: local
