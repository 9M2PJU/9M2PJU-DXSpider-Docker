name: Build and Test

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

env:
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  build:
    name: Build Multi-Arch Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ env.PLATFORMS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-

      - name: Build Docker image (mojo branch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ env.PLATFORMS }}
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            SPIDER_VERSION=mojo
          outputs: type=docker,dest=/tmp/image-mojo.tar

      - name: Build Docker image (master branch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          tags: test-master:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          build-args: |
            SPIDER_VERSION=master
          load: true

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Load mojo image for testing
        run: |
          docker load --input /tmp/image-mojo.tar
          docker tag $(docker images -q | head -n 1) test:latest

      - name: Create test environment file
        run: |
          cat > .env.test << 'EOF'
          CLUSTER_CALLSIGN=TEST-99
          CLUSTER_DXSPIDER_BRANCH=mojo
          CLUSTER_SYSOP_NAME=Test Sysop
          CLUSTER_SYSOP_CALLSIGN=TEST
          CLUSTER_SYSOP_PASSWORD=testpass
          CLUSTER_SYSOP_EMAIL=test@example.com
          CLUSTER_SYSOP_BBS_ADDRESS=TEST@WW
          CLUSTER_LATITUDE=+51.5
          CLUSTER_LONGITUDE=-0.13
          CLUSTER_LOCATOR=JO01AA
          CLUSTER_QTH=Test Location
          CLUSTER_DX_HOSTNAME=test.example.com
          CLUSTER_PORT=7300
          CLUSTER_SYSOP_PORT=8050
          CLUSTER_DB_USER=sysop
          CLUSTER_DB_PASS=testpass
          EOF

      - name: Run smoke tests
        run: |
          chmod +x ./scripts/smoke-test.sh
          ./scripts/smoke-test.sh

      - name: Display container logs on failure
        if: failure()
        run: |
          docker logs dxspider-test 2>&1 || echo "No container logs available"

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            /tmp/test-*.log
          retention-days: 7

  lint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          ignore: DL3018,DL3013

  shellcheck:
    name: ShellCheck Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: './scripts'
          ignore_paths: './local_data'
          severity: warning

      - name: Check entrypoint.sh
        run: |
          shellcheck -x entrypoint.sh || true

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, lint, shellcheck]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "Build: ${{ needs.build.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "ShellCheck: ${{ needs.shellcheck.result }}"

          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "❌ Build failed"
            exit 1
          fi

          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "⚠️ Linting issues detected"
          fi

          if [[ "${{ needs.shellcheck.result }}" != "success" ]]; then
            echo "⚠️ ShellCheck issues detected"
          fi

          echo "✅ Build completed successfully"
