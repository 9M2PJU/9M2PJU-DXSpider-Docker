# Production values for dxspider
# This file contains recommended settings for production deployments
# Use with: helm install dxspider ./dxspider -f values-production.yaml

# =============================================================================
# Image Configuration
# =============================================================================
image:
  # Use specific version tag instead of 'latest' for production
  tag: "1.57"
  # Always pull to ensure latest version
  pullPolicy: Always

# =============================================================================
# Resource Configuration (Production)
# =============================================================================
resources:
  limits:
    cpu: 4000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 256Mi

# =============================================================================
# Persistence Configuration (Production)
# =============================================================================
persistence:
  # Always enable persistence in production
  enabled: true
  # Use production-grade storage class
  storageClass: "fast-ssd"
  # Larger storage for production
  size: 50Gi
  # Backup annotations for production
  annotations:
    backup.velero.io/backup-volumes: "data"
    backup.velero.io/backup-volumes-excludes: ""

# =============================================================================
# Ingress Configuration (Production)
# =============================================================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    # Enable SSL/TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    # Security headers
    nginx.ingress.kubernetes.io/enable-cors: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

  hosts:
    - host: dxspider.example.com
      paths:
        - path: /console
          pathType: Prefix
          service: console
        - path: /metrics
          pathType: Prefix
          service: metrics

  # Enable TLS with cert-manager
  tls:
    - secretName: dxspider-tls
      hosts:
        - dxspider.example.com

# =============================================================================
# Service Configuration (Production)
# =============================================================================
service:
  # Use LoadBalancer for production telnet access
  type: LoadBalancer
  # Restrict access to specific IP ranges
  loadBalancerSourceRanges:
    - "0.0.0.0/0"  # Replace with your allowed IP ranges

  telnet:
    annotations:
      # Cloud provider specific annotations
      # service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      # service.beta.kubernetes.io/azure-load-balancer-resource-group: "myResourceGroup"

# =============================================================================
# Metrics and Monitoring (Production)
# =============================================================================
metrics:
  enabled: true

  serviceMonitor:
    enabled: true
    # Label required for Prometheus Operator to discover this ServiceMonitor
    additionalLabels:
      prometheus: kube-prometheus
    interval: 30s
    scrapeTimeout: 10s

# =============================================================================
# Health Checks (Production - More Aggressive)
# =============================================================================
healthcheck:
  livenessProbe:
    enabled: true
    exec:
      command:
        - /bin/sh
        - -c
        - nc -z localhost 7300 && pgrep -f cluster.pl > /dev/null
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

  readinessProbe:
    enabled: true
    exec:
      command:
        - /bin/sh
        - -c
        - nc -z localhost 7300
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  startupProbe:
    enabled: true
    exec:
      command:
        - /bin/sh
        - -c
        - nc -z localhost 7300
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 60  # Allow 5 minutes for startup

# =============================================================================
# Pod Configuration (Production)
# =============================================================================
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9100"
  prometheus.io/path: "/metrics"

# Security context - restrict pod capabilities
podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000

# =============================================================================
# StatefulSet Configuration (Production)
# =============================================================================
statefulset:
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: OrderedReady
  # Longer grace period for clean shutdown
  terminationGracePeriodSeconds: 60

# =============================================================================
# High Availability and Resilience
# =============================================================================
# Node affinity to prefer dedicated nodes
affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: workload-type
              operator: In
              values:
                - dxspider
  # Anti-affinity to avoid single point of failure (if running multiple instances)
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: dxspider
          topologyKey: kubernetes.io/hostname

# Tolerations for dedicated nodes
tolerations:
  - key: "workload-type"
    operator: "Equal"
    value: "dxspider"
    effect: "NoSchedule"

# Priority class for production workloads
priorityClassName: "high-priority"

# =============================================================================
# Database Configuration (Production - Optional)
# =============================================================================
database:
  # Enable database for production
  enabled: true
  type: "mysql"
  hostname: "mariadb.database.svc.cluster.local"
  port: 3306
  name: "dxspider"
  user: "sysop"
  # Password should be set via --set or external secret
  password: "CHANGE_ME_IN_PRODUCTION"

# =============================================================================
# Cluster Configuration (Production Example)
# =============================================================================
cluster:
  callsign: "9M2PJU-10"
  branch: "mojo"

  location:
    latitude: "+51.5"
    longitude: "-0.13"
    locator: "OJ03UD"
    qth: "Kuala Lumpur, Malaysia"

  network:
    hostname: "dxspider.example.com"
    port: 7300
    sysopPort: 8050
    metricsPort: 9100

# =============================================================================
# Sysop Configuration (Production)
# =============================================================================
sysop:
  name: "Piju"
  callsign: "9M2PJU"
  email: "9m2pju@hamradio.my"
  bbs_address: ""
  # Password should be set via --set or external secret
  password: "CHANGE_ME_IN_PRODUCTION"

# =============================================================================
# Partner Node Connections (Production Example)
# =============================================================================
config:
  connections:
    9m2pju-2:
      timeout 15
      connect telnet dx.example.com 7300
      'login:' '9M2PJU-10'

# =============================================================================
# Advanced Configuration
# =============================================================================
# Additional environment variables for production
extraEnv:
  - name: TZ
    value: "Asia/Kuala_Lumpur"
  - name: LANG
    value: "en_US.UTF-8"

# Backup init container example
initContainers:
  - name: backup-restore
    image: alpine:3.20
    command:
      - sh
      - -c
      - |
        echo "Checking for backups..."
        # Add backup restore logic here
    volumeMounts:
      - name: data
        mountPath: /spider/local_data
